# Interceptor

زمانی اتفاق می افته که قبل از route handler اتفاق می افته .

و همینطور بعد از route handler .

منظور از route handler همون controller هستش .

پس به request وردی و response خروجی می تونه تاثیر بزاره .

و می تونیم تغییراتی بدیم .

مثلا می تونیم بگیم update_at نباشه یا تغییر داشته باشه بشه updateAt

یا پسورد کاربر نمی خوایم ارسال شه حذفش می کنیم .

یکی از کار هاش تغییر response هست دیتای که قرار توی response

داشته باشیم رو تغییر بدیم یا حذف کنیم که میشه transform .

نکته : این کار حذف کردن داده ها رو به وسیله متد select prisma هم

می تونیم انجام بدیم اونجای که دیتا رو داریم درون سرویس می فرستیم .

ولی می خوایم با interceptor اشنا شیم .

# create interceptor

یک فولدر به اسم interceptor درون فولدر src ایجاد می کنیم .

برای هر module که درون پروژه هست می تونیم interceptor تعریف کنیم .

اینجا برای ماژول user میایم یک interceptor تعریف می کنیم

فولدر interceptor رو درون user ایجاد می کنیم .

درون این فولدر یک فایل به اسم transform.interceptor.ts ایجاد می کنیم .

در واقع interceptor یک کلاس هست میسازیم و export می کنیم .

و همینطور impelemetns می کنیم از nestjsInterceptor که از nestjs/comman میاید .

یک متد داره به اسم intercept که 2 تا parameter داره .

یکی context .
یکی handler هست .

که از نوع callhanler هست

و context از نوع ExecutionContext هست .

# ExecutionContext , ArgumentsHost

یک سری کلاس اماده داریم درون nestjs .

که بتونیم اطلاعات رو از درون application که داریم در بیاریم .

دو 2تا کلاس داریم به اسم ArgumentsHost و ExecutionContext

می تونیم یک سری اطلاعات از این دو تا بکشیم بیرون .

## ArgumentsHost

ارگمون هاست میاد یک سری متد ها برای ما برگشت میده

که این متد ها به ما اطلاع میدن

کاری که ArgumentsHost انجام میده یک سری متد ها رو برگشت میده

که این متد های ArgumentsHost به ما می گن arguman یا وردی های که

به handler پاس داده شده چه چیزای هستند .

Handler در واقع همون controller ما هست که یک سری وردی می گیره .

مثلا در خواست از نوع post بوده قرار کنترل مربوط به user صدا زده شه

و درون controller user بیاد متد create صدا زده شده .

در کل یک سری وردی ها به handler یا همون controller میدیم .

که می تونیم به وسیله ArgumentsHost بهشون دسترسی داشته باشیم .
اینجوری متوجه میشیم که argument های پاس داده شده به controller چه چیزای هستند .

حالا با توجه به نوع استفاده ما از controller می تونه argumentهای که داریم

متفاوت شه . مثلا اگر websocket باشه یک سری چیزا داریم .

اگر restful باشه یکی سری argumentدیگه داریم

اگر میکروسرویس باشه باز یکی سری چیزای دیگه داریم .

خب nestjs یک instance برای ArgumentsHost ایجاد می کنه به اسم host

که درون این host یک سری اطلاعات دریافت می کنیم .

به وسیله این host می تونیم اطلاعاتمون رو دریافت کنیم .

به عنوان مثال تایپ پروژه nestjs ما چی هستش ؟ graphql هست یا restful

یا میکروسرویس یا وب سوکت..

که به وسیله متد getType می تونیم اینکارو انجام بدیم متوجه تایپ پروژه شیم .

به وسیله getType می تونیم بخش های مختلف پروژه رو چک کنیم .

که اگر مثلا نوع تایپ http بو بیاد یک سری کار رو برای ما انجام بده

یا اگر graphql بود بیاد یک سری کار ها رو انجام بده .

اگر میکروسرویس یا وب سوکت بود بیاد یک سری کار رو انجام بده

واین موارد رو به وسیله متد getType که در host هست می تونیم متوجه شیم .

یک متد دیگه هست به اسم getarg داره می تونیم وردی های که به هندلر پاس داده شده دریافت کنیم همون req , res , next .

### getArgs

به وسیله این متد getArgs که از host میاد .

می توینم وردی های که به handler پاس داده شده دریافت کنیم .

که request چی بوده یا response چی بوده و همینطور می تونیم به next دسترسی داشته باشیم .

این getArgs متفاوت هست برای http یا همون restful متفاوته .

برای microservice , webscoket , graph متفاوت هست .

نکته : handler در واقع همون controller ما هستش .

### getArgByIndex :

یک مورد دیگه که می تونیم از host داشته باشیم

به اسم getargs by index .

که شماره می گیره 0 مثلا میشه req و 1 میشه response

### SwitchTo

این متد به ما کمک می کنه یک سری اطلاعات بتونیم دریافت کنیم .

بر اساس نوع app که داریم میایم از نوع های مختلف switchTo استفاده می کنیم

به عنوان مثال اگر app ما داره از restful استفاده می کنه میایم برای دریافت اطلاعات

از switchToHTTP استفاده می کنیم .

که این switchTo در واقع کار کردن با getArgs رو راحتر می کنه .

که باز استفاده ازش به نوع پروژه بستگی داره باز اگر وب سوکت باشه یه جور هست

اگر restful باشه یک طور دیگه استفاده میشه .

اگر بگیم switch to ws میاد websocket شو بر می گردونه .

که وقتی switch روشون اعمال میشه هر کدوم متد های خودشون رو دارن

برای restful متد getResponce , getRequset رو داره .

Switch میاد یک سری متد ایجاد می کنه که ساده تر بتونیم

به متد های مربوط دسترسی داشته باشیم .

مثلا switchToHTTP باعث میشه که ساده تر به دسترسی داشته باشیم

به وردی ها یا همون arguments های که داره درون handler گرفته میشه .

که اگر پروژه ما از نوع HTTP باشه وردی های ما میشه همون req , res , next

# ExecutionContext class

این ExecutionContext در واقع extends شده از argumentsHost

که میاد یک سری اطلاعات اضافه تر در اختیار ما می زاره .

مثل getClass و getHandler 2 تا متد اضافه تر داره .

که getClass تایپ کنترلر رو برگشت میده که چه controller هست .

و getHandler میاد متد شو برگشت میده .

یک در خواست POST داریم .

درون داکیومنت مثالش زده شده .

و برای اینکه بدونیم این درخواست POST در چه route داره اجرا میشه .

از getHandler استفاده می کنیم که ببینم داره در چه route استفاده میشه .

# Summary

می تونیم به Requset , و response دسترسی داشته باشیم از متد swtichToHttp استفاده می کنیم

یا می تونیم از getHeader یا getClass استفاده کنیم تا به اطلاعات متد و کنترلر دسترسی داشته باشیم .

در ادامه next رو داریم که callHandler هست که اجازه میده روت هندلر رو صدا بزنیم

که در واقع همون controller هست که این callHandler اجازه صدا زدن
route handler رو به ما میده .

که interceptor هم قبل از Route handler می تونیم دسترسی داشته باشیم یک سری کار هارو انجام بدیم

هم بعد از route هندلر دسترسی داشته باشیم و یک سری کار هار و انجام بدیم .
